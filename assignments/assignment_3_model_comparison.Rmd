---
title: "Assignment 3: Model comparison solutions"
author: "Anna Noemi Illes"
output: html_document
---

In this lab assignment you are going to work with (simulated) data related to perioperative pain and its psychological and hormonal predictors. In the assignment you will assess the added benefit of including some psychological and hormonal predictors to the already established demographic predictors of pain.

In this assignment you will set up a hierarchical regression model to predict postoperative pain after wisdom tooth surgery. 

# Research problem

The amount of pain experienced around and after surgeries are highly variable between and within individuals. In order to improve surgical pain management regimens we need to understand what influences pain around surgical procedures and predict the amount of pain an individual will experience.

Your first study in this area is related to assessing the influence of trait and state psychological measures on pain, and to see whether taking into account these variables can improve our understanding of postoperative pain.

# Procedures and measures

Use the data file called ‚Äòassignment_3_dataset‚Äô, from the 'data/' folder.

You have collected data from 160 adults who were scheduled to undergo surgical extraction of the third mandibular molar (wisdom tooth surgery). Patients filled out a form in the waiting room before their surgery. The form contained questions about their sex, age, and weight, and psychological questionnaires assessing anxiety, pain catastrophizing, and mindfulness (see descriptions below). You also got blood samples and saliva samples from participants in the waiting room 5 minutes before their operations to determine the serum (a component of the blood) and salivary cortisol levels of participants. Participants were contacted 5 hours after the surgery to see how much pain they were experiencing. The __level of pain__ at that moment was recorded using a numerical rating scale using a __scale of 0 to 10__, where 0 means ‚Äúno pain‚Äù and 10 means ‚Äúworst pain I can imagine‚Äù. 

__The State Trait Anxiety Inventory:__ T measures trait anxiety on a scale of 20 to 80, higher scores mean higher anxiety. Anxiety has been found in many studies to positively correlate with the level of pain experienced. This is __variable STAI_trait__ in the dataset.

__The Pain Catastrophizing Scale__ measures the extent of pain catastrophizing, which is characterized by a tendency to magnify the threat value of a pain stimulus and to feel helpless in the presence of pain, as well as by a relative inability to prevent or inhibit pain-related thoughts in anticipation of, during, or following a painful event. The total score on this scale ranges from 0 to 52, higher scores mean higher catastrophizing. Pain catastrophizing is one of the well-established predictors of clinical pain. This is __variable pain_cat__ in the dataset.

__The Mindful Attention Awareness Scale (MAAS)__ measures dispositional mindfulness, which may be described as a tendency to turn attention to present-moment experiences in an open, non-judgmental way. The MAAS total score ranges from 1 to 6 (an average of the item scores), with higher scores representing higher dispositional mindfulness. Trait mindfulness has been theorized to serve as a protective factor against pain, as the individual would be more objective about their pain experience and tend to associate less discomfort, despair, and hopelessness to the pain-related sensations. This is __variable mindfulness__ in the dataset.

__Cortisol__ is a stress hormone associated with acute and chronic stress. Cortisol levels are thought to be positively associated with pain experience. Cortisol can be __measured from both blood and the saliva__, although, serum cortisol is often regarded in medical research as more reliably related to stress (serum is a component of the blood plasma). These are __variables cortisol_serum__, and __cortisol_saliva__ in the dataset.

# Research question

Previous studies and meta-analyses showed that age and sex are often predictors of pain (age is negatively associated with pain, while sex is a predictor more dependent on the type of the procedure). You would like to determine the extent to which taking into account psychological and hormonal variables aside from the already used demographic variables would improve our understanding of postoperative pain.

To answer this research question you will __need to compare two models__ (with a hierarchical regression). The __simpler model__ should contain __age and sex as predictors of pain__, while the __more complex model__ should contain the __predictors: age, sex, STAI, pain catastrophizing, mindfulness, and cortisol measures__. Notice that the predictors used in the simpler model are a subset of the predictors used in more complex model. __You will have to do model comparison to assess whether substantial new information was gained about pain in the more complex model compared to the simpler model.__  

# What to report

As usual, before you can interpret your model, you will need to run data and model diagnostics. First, check the variables included in the more complex model (age, sex, STAI, pain catastrophizing, mindfulness, and cortisol measures as predictors, and pain as an outcome) for __coding errors__, and the model itself for __influential outliers__ (for example using Cook‚Äôs distance). Furthermore, check the final model to see if the __assumptions of linear regression hold true__, that is, __normality__ (of the residuals), __linearity__ (of the relationship), __homogeneity of variance__ (also called homoscedasticity) and that there is no excess __multicollinearity__ (‚Äúuncorrelated predictors‚Äù in Navarro‚Äôs words). If you find anything amiss during these checks, make the appropriate decision or correction and report your findings and actions in your report. 

__Note:__ If you do any changes, such as exclude cases, or exclude predictors from the model, you will have to re-run the above checks for your final data and model.

Report the results of the simpler model and the more complex model. For both models you should report the model test statistics (adj.R2, F, df, and p value). Also, report the statistics describing the coefficients of the predictors in a table format (unstandardized regression coefficients and 95% confidence intervals, standardized regression coefficients (B and Beta values), and p values).

Write up the regression equation of the more complex model in the form of ùëå = ùëè0 + ùëè1 ‚àó X1 + ùëè2 ‚àó X2 +‚Ä¶+ bn * Xn, in which you use the actual regression coefficients of your models. (b0 stands for the intercept and b1, b2 ‚Ä¶ bn stand for the model coefficients for each of the predictors, and X1, X2, ‚Ä¶ Xn denote the predictors).

Compare the two models in terms of how much variance they explain of pain‚Äôs variability in the sample. Report Akaike information criterion (AIC) for both models and the F test statistic and p value of the likelihood ratio test comparing the two models.

# What to discuss

In your discussion of the findings, briefly interpret the results of the above analyses, and indicate whether you think that anything was gained by including the psychological and hormone measures in the model.

# Solution

## Read the data

*Read the dataset used in this assignment. Pay attention to the extension of the datafile.*

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(car)
library(corrplot)
library(lmtest)
library(sandwich)
library(psych)
```


```{r read}
df <- read_xlsx("/Users/illesanna/Desktop/DOKUMENTUMOK/ELTE/MESTER/semester1/data_analysis_r/KPTUXW_interim_assignments/KPTUXW_interim_assignments/data/assignment_3_dataset.xlsx")
```

## Data and model diagnostics 
### Data diagnostics
#### Descriptives of the variables

*Missingness pattern*

No missing items were detected.

```{r missingness}
sapply(df, function(x) sum(is.na(x)))

```


##### Correct coding errors

*If you find values in the dataset during the EDA, that are not correct based on the provided descriptions of the variables of the dataset please correct them here.*

An **incorrect mindfulness value** was identified at observation 42, exceeding the scale maximum of 6. After correcting this value, **binary variables (sex) were recoded** such that 0 represented male and 1 represented female for subsequent analysis.

```{r clean}
glimpse(df_clean %>% select(-ID))

summary(df_clean %>% select(-ID))

df_desc <- df_clean %>%
  select(-ID) %>%
  summarise(
    across(where(is.numeric), 
           list(
             mean = ~mean(.x, na.rm = TRUE),
             sd   = ~sd(.x, na.rm = TRUE),
             min  = ~min(.x, na.rm = TRUE),
             max  = ~max(.x, na.rm = TRUE)
           ))
  )

df_desc

df_clean <- df %>%
  mutate(mindfulness = if_else(mindfulness > 6, 6, mindfulness)) %>%
  mutate(sex = case_when(
      sex == "male"   ~ 0,
      sex == "female" ~ 1)
  )
```

##### EDA

To examine the relationships among variables and their association with pain, a **correlation matrix** was computed. All variables demonstrated small to moderate correlations with pain, with cortisol showing the strongest associations *(serum: r = .26; saliva: r = .28)*. Consistent with prior research, age and mindfulness were negatively correlated with pain, indicating that older participants and those with higher dispositional mindfulness tended to report lower levels of pain.

For a detailed overview of the correlations across all variables, refer to the correlation plot below. 

```{r correlation}
correlation <- cor(
  df_clean[, -1],
  use = "pairwise.complete.obs"
)

corrplot(correlation, method = "color",
         type = "upper",          
         tl.col = "black",         
         tl.srt = 45,             
         addCoef.col = "black",   
         number.cex = 0.7,         
         diag = FALSE) 
```



### Model diagnostics
#### Build the simple model

*In order to test the more complex model for outliers and to test the assumptions first build the model.*

A **linear regression** analysis was conducted to examine whether age and sex can predict pain level scores. The model indicated that age was negatively associated with pain (B = -0.08), such that pain slightly decreased with increasing age. Sex showed a moderate positive association with pain (B = 0.46), indicating that females reported higher pain than males.

Pain = 8.21 - 0.08(age) + 0.46(sex)

```{r model0}
m0 <- lm(pain ~ age + sex, data = df_clean)
m0
```

##### Checking for influential outliers

Check for outlier values in the model.

A plot of **residuals versus fitted values** was examined to assess the linearity of the model and to assess influential outliers. A single outlier, **observation 142** was detected as a significant outlier, further supported by studentized residuals *(r_student = 30.57, p < .001)*. 

```{r outliers model0}
plot(m0, which = 1)
outlierTest(m0)
```


##### Checking assumptions

*Check the normality assumption.*

A **Q-Q plot** was created to check the normal distibution of residuals. Visual inspection suggest an approximately normal distribution of residuals. A **Shapiro-Wilk** test was also employed to further assess normality, however, the test resulted a significant deviation from normality, likely due to the outlier score observation 142, *(W = 0.34, p < .001)*.

```{r normality model0}
qqnorm(resid(m0))
qqline(resid(m0), col = "red")

shapiro.test(resid(m0))
```


*Check the homoscedasticty assumption (homogeneity of variance).*

The assumption of homoscedasticity was tested using the **Breusch-Pagan test**. The result was non-significant, indicating that that residual variance is constant across levels of the predictors, BP(2) = 1.03, p = .60.

```{r bp0}
lmtest::bptest(m0)
```

*Check the multicollinearity assumption.*

(VIF above 5), or a VIF threshold of 3 is recommended in this paper: http://onlinelibrary.wiley.com/doi/10.1111/j.2041-210X.2009.00001.x/full

Some info about VIF: 
https://statisticalhorizons.com/multicollinearity
http://blog.minitab.com/blog/understanding-statistics/handling-multicollinearity-in-regression-analysis

**Variance inflation factors (VIFs)** were examined to assess multicollinearity. All VIFs were close to 1 (age = 1.003, sex = 1.003), indicating no evidence of multicollinearity among the predictors.

```{r vif0}
car::vif(m0)
```

##### Making decision based on model diagnostics

*If based on the assumption tests you decide to drop a predictor variable you should do that here. Create your updated model.*

Due to results above in the residuals vs fitted values plot, as well as studentized residuals and significant deviation from normality according to the Shapiro-Wilk test, **observation 142 was excluded and a new model (m1) was created**. 

The new model (m1) indicated that age was still negatively associated with pain (B = -0.09), such that pain slightly decreased with increasing age. Sex showed a mild negative association with pain (B = -0.09), indicating that males report slightly higher pain levels than women.

Pain = 8.49 - 0.09(age) - 0.09(sex)

```{r model1}
df_normal <- df_clean[-142, ]

m1 <- lm(pain ~ age + sex, data = df_normal)
m1
```

##### Checking outliers of the updated model

The plot of **residuals versus fitted values** was examined to assess the linearity of the new model (m1) and to assess influential outliers. In the updated model, residuals were appoximately evenly distributed and centered around zero, with a slight curvature, suggesting a mild non-linearity between predictors and outcome. Outliers flagged were not excluded from subsequent analysis.

```{r linearity model1}
plot(m1, which = 1)
outlierTest(m1)
```


##### Checking assumptions of the updated model

*Normality assumption*

A **Q-Q plot** was created to check the normal distibution of residuals in the updated model (m1) following exclusion of the outlier item. Visual inspection suggest an approximately normal distribution of residuals, with a slight curvature at the tails. A **Shapiro-Wilk** test was also employed to assess normality, with results indicating an even distribution, *(W = .99, p = .19)*.

```{r normality model1}
qqnorm(resid(m1))
qqline(resid(m1), col = "red")

shapiro.test(resid(m1))
```

*Homoscedasticty assumption (homogeneity of variance)*

A **Breusch-Pagan test** was conducted to assess the assumption of homoscedasticity in the updated model (m1). Results indicated a significant violation of this assumption, suggesting the presence of heteroscedasticity in the model, *BP(2) = 6.78, p = .034*.

```{r bp1}
lmtest::bptest(m1)
```

*Multicollinearity assumption*

**Variance inflation factors (VIFs)** were examined to assess multicollinearity. All VIFs were close to 1 (age = 1.003, sex = 1.003) and remained near unchanged from the previous model, indicating no evidence of multicollinearity among the predictors.

```{r vif1}
car::vif(m1)
```


#### Build the more complex model

*In order to test the more complex model for outliers and to test the assumptions first build the model.*

A **multiple linear regression** (m2) was conducted to examine the predictors of pain, including *age, sex, trait anxiety (STAI_trait), pain catastrophizing (pain_cat), mindfulness and cortisol (serum, saliva)*. I used the dataset in which observation 142 is already excluded. 

Pain catastrophizing was positively related to pain (B = 0.10), as was cortisol mesaured from saliva (B = 0.44), suggesting that higher catastrophizing and higher salivary cortisol levels are associated with greater reported pain. Mindfulness was negatively associated with pain (B = -0.13), indicating that higher mindfulness was linked to lower pain levels. Serum cortisol (cortisol extracted from blood) showed a small positive association (B = 0.17). Age (B = -0.02) and trait anxiety (B = -0.03) exhibited negligible effects in this model, while sex was negatively associated with pain (B = -0.32), indicating that females reported slightly lower pain than males.

Pain = 1.65 - 0.02(age) - 0.32(sex) - 0.03(STAI_trait) + 0.1(pain_cat) - 0.13(mindfulness) + 0.17(cortisol_serum) + 0.44(cosrtisol_saliva)

```{r model2}
m2 <- lm(pain ~ age + sex + STAI_trait + pain_cat + mindfulness + cortisol_serum + cortisol_saliva, data = df_normal)
m2
```

#### Checking assumptions and outliers

*Checking linearity and outliers in the model.*

A **residuals versus fitted values** plot was created to assess the linearity of the model and to assess influential outliers. In the model (m2), residuals were appoximately evenly distributed and centered around zero, suggesting a linear connection between predictors and outcome. Outliers flagged were not excluded from subsequent analysis.

```{r linearity model2}
plot(m2, which = 1)
outlierTest(m2)
```


*Check the normality assumption.*

A **Q-Q plot** was created to check the normal distibution of residuals in the complex model (m2). Visual inspection suggest an approximately normal distribution of residuals, with a slight curvature at the tails. A **Shapiro-Wilk** test was also employed to assess normality, with results indicating an even distribution, *(W = 0.99, p = 0.82)*.

```{r normality model2}
qqnorm(resid(m2))
qqline(resid(m2), col = "red")

shapiro.test(resid(m2))
```

*Check the homoscedasticty assumption (homogeneity of variance).*

The **Breusch-Pagan test** indicated no evidence of heteroscedasticity in the model, *BP(7) = 6.75, p = .455*. 

```{r bp2}
lmtest::bptest(m2)
```

*Check the multicollinearity assumption.*

**Variance inflation factors (VIFs)** indicated low multicollinearity for age (VIF = 1.49), sex (VIF = 1.14), trait anxiety (VIF = 2.12), pain catastrophizing (VIF = 1.93), and mindfulness (VIF = 1.54), whereas serum cortisol (VIF = 5.99) and salivary cortisol (VIF = 6.54) showed moderate multicollinearity.

```{r vif2}
car::vif(m2)
```

## Model comparison

*Compare the two models.*

To compare models, I used a nested F-test, which measures whether adding predictors significantly improve model fit.

The **simple model (m1)**, which served as the baseline models of the hierarchical multiple regression, included factors age and sex. The baseline explained a total of 8% *(R2 = .08, adjusted R2 = .07, F(2,155) = 6.77, p < .05)* of the variance in the level of pain reported. The **complex model (m2)**, which included psychological and hormonal variables such as anxiety, dispositional mindfulness, pain catastrophising and cortisol (both from saliva and blood) besides age and sex, explained a total of 35.8% of the total variance in the level of pain *(R2 = .35, adjusted r2 = .33, f (7, 150) = 12.0, p < .001)*. The addition of these variables accounted for and additional 27.8% percent of the variance comapred to the baseline.

In the simple model (m1), the **Akaike Information Criterion (AIC)** equaled 575, while in the second model the AIC value was 528. This suggests that adding psychological and hormonal factors improves model fit compared to the baseline.

```{r model comparison}
anova(m1, m2)
broom::glance(m1)
broom::glance(m2)
```


**Summary:** The results indicate that age and sex alone explain only a small proportion of variance in pain. In contrast, the inclusion of psychological (trait anxiety, pain catastrophizing, mindfulness) and biological (serum and salivary cortisol) variables substantially improves the explanatory power of the model, accounting for an additional 27.8% of the variance in pain. This finding suggests that pain is more strongly associated with psychological and physiological factors than with basic demographic characteristics alone.
